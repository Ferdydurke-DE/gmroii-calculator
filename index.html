<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GMROII &amp; GMROS Calculator for Booksellers</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f4f6f9;
  --card: #ffffff;
  --border: #dce1e8;
  --text: #1a2332;
  --muted: #5a6a7e;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --green: #16a34a;
  --green-light: #dcfce7;
  --red: #dc2626;
  --red-light: #fee2e2;
  --orange: #ea580c;
  --orange-light: #ffedd5;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
}

/* Bookshelf backdrop */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: -1;
  background: url('bookshelf-bg.jpg?v=2') center/cover no-repeat fixed;
  opacity: 0.4;
}

h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.subtitle {
  color: var(--text);
  font-size: 0.875rem;
  margin-bottom: 24px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
}

.card h2 {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 16px;
  font-weight: 600;
}

/* Input Panel */
.input-panel {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.field label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  margin-bottom: 6px;
}

.field input[type="text"],
.field input[type="number"],
.field select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.95rem;
  color: var(--text);
  background: #fff;
  transition: border-color 0.15s;
}

.field input:focus, .field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.slider-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.slider-group input[type="range"] {
  flex: 1;
  accent-color: var(--accent);
  cursor: pointer;
}

.slider-group input[type="number"] {
  width: 70px;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: center;
}

.slider-group input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

/* Dashboard Grid */
.dashboard {
  display: grid;
  grid-template-columns: 280px 1fr;
  grid-template-rows: auto auto auto;
  gap: 20px;
  margin-bottom: 24px;
}

/* Key Metrics */
.metrics-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  grid-row: 1 / 4;
}

.metric-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}

.metric-card .metric-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  font-weight: 600;
}

.metric-card .metric-value {
  font-size: 1.8rem;
  font-weight: 700;
  margin-top: 4px;
  line-height: 1.2;
}

.metric-card .metric-sub {
  font-size: 0.78rem;
  color: var(--muted);
  margin-top: 2px;
}

.metric-card .metric-formula {
  font-size: 0.7rem;
  color: var(--muted);
  margin-top: 4px;
  font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
  background: #f0f2f5;
  padding: 3px 6px;
  border-radius: 4px;
  line-height: 1.4;
}

.comparison-table .formula {
  display: block;
  font-size: 0.65rem;
  font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
  color: var(--muted);
  margin-top: 1px;
}

.metric-card.highlight {
  border-color: var(--accent);
  background: linear-gradient(135deg, var(--accent-light) 0%, #fff 100%);
}

.metric-card.highlight .metric-value { color: var(--accent); }

.metric-card.positive .metric-value { color: var(--green); }
.metric-card.negative .metric-value { color: var(--red); }

.cashflow-ok { color: var(--green); font-weight: 600; }
.cashflow-warn { color: var(--orange); font-weight: 600; }
.cashflow-bad { color: var(--red); font-weight: 600; }

/* Comparison Table */
.comparison-section { grid-column: 2; }

.comparison-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.comparison-table th {
  text-align: left;
  padding: 8px 12px;
  border-bottom: 2px solid var(--border);
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--muted);
  font-weight: 600;
}

.comparison-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}

.comparison-table tr.optimal {
  background: var(--green-light);
  font-weight: 600;
}

.comparison-table tr.current {
  background: var(--accent-light);
}

.comparison-table tr:hover {
  background: #f0f4ff;
}

.tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 6px;
}

.tag-optimal { background: var(--green-light); color: var(--green); }
.tag-current { background: var(--accent-light); color: var(--accent); }

.coverage-full { color: var(--green); font-weight: 600; }
.coverage-short { color: var(--red); font-weight: 600; }

.comparison-table tr.suboptimal {
  background: var(--red-light);
  opacity: 0.7;
}
.tag-suboptimal { background: var(--orange-light); color: var(--orange); }

/* Chart Section */
.chart-section {
  grid-column: 2;
}

.chart-container {
  position: relative;
  width: 100%;
}

.chart-container svg {
  width: 100%;
  height: auto;
  display: block;
}

.chart-title {
  font-size: 0.75rem;
  color: var(--muted);
  text-align: center;
  margin-top: 8px;
}

/* Discount Step Advisor */
.advisor-section {
  grid-column: 2;
}

.advisor-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.advisor-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.advisor-result {
  padding: 16px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.advisor-result.worth-it {
  background: var(--green-light);
  border-color: #86efac;
}

.advisor-result.not-worth-it {
  background: var(--red-light);
  border-color: #fca5a5;
}

.advisor-result.neutral {
  background: var(--orange-light);
  border-color: #fdba74;
}

.advisor-verdict {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.advisor-explanation {
  font-size: 0.75rem;
  color: var(--text);
  line-height: 1.4;
}

/* Responsive - tablet */
@media (max-width: 900px) {
  .dashboard {
    grid-template-columns: 1fr;
  }
  .metrics-panel {
    grid-row: auto;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .metric-card { flex: 1; min-width: 140px; }
  .comparison-section, .chart-section, .advisor-section { grid-column: 1; }
  .advisor-grid { grid-template-columns: 1fr; }
}

/* Responsive - mobile */
@media (max-width: 600px) {
  body { padding: 10px; }
  h1 { font-size: 1.2rem; }
  .subtitle { font-size: 0.78rem; }

  .input-panel {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .input-panel .field[style*="span 2"] {
    grid-column: span 1 !important;
  }

  .field input[type="number"],
  .field input[type="text"],
  .field select {
    font-size: 16px; /* prevents iOS zoom on focus */
    padding: 10px;
  }

  .slider-group {
    flex-wrap: wrap;
  }
  .slider-group input[type="range"] {
    width: 100%;
    flex: none;
  }

  .metrics-panel {
    flex-direction: column;
  }
  .metric-card {
    min-width: 0;
    flex: none;
    width: 100%;
  }
  .metric-card .metric-value {
    font-size: 1.4rem;
  }
  .metric-card .metric-formula {
    font-size: 0.63rem;
    overflow-x: auto;
    white-space: nowrap;
  }

  .comparison-table {
    font-size: 0.75rem;
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .comparison-table th,
  .comparison-table td {
    padding: 6px 8px;
    white-space: nowrap;
  }
  .comparison-table .formula {
    display: none;
  }

  .chart-container svg {
    height: auto;
  }

  .advisor-grid {
    grid-template-columns: 1fr;
  }
  .advisor-inputs {
    grid-template-columns: 1fr;
  }
  .advisor-verdict { font-size: 1.1rem; }
  .advisor-explanation { font-size: 0.78rem; }

  .card { padding: 14px; }
  .card h2 { font-size: 0.72rem; }
}

.info-tip {
  display: inline-block;
  width: 15px;
  height: 15px;
  line-height: 15px;
  text-align: center;
  border-radius: 50%;
  background: var(--border);
  color: var(--muted);
  font-size: 0.6rem;
  font-weight: 700;
  cursor: help;
  margin-left: 4px;
  vertical-align: middle;
}

/* Lexicon */
.lexicon-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}

.lexicon-toggle .toggle-arrow {
  transition: transform 0.25s ease;
  font-size: 0.75rem;
  color: var(--muted);
}

.lexicon-toggle .toggle-arrow.open {
  transform: rotate(180deg);
}

.lexicon-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
}

.lexicon-panel.open {
  max-height: 2000px;
}

.lexicon-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
  padding-top: 16px;
}

.lexicon-term h3 {
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 4px;
}

.lexicon-term p {
  font-size: 0.8rem;
  color: var(--muted);
  line-height: 1.5;
}
</style>
</head>
<body>

<h1>GMROII &amp; GMROS Calculator</h1>
<p class="subtitle">Restocking decisions guided by Gross Margin Return on Inventory Investment &mdash; based on Shatzkin's <em>The Mathematics of Bookselling</em></p>

<!-- INPUT PANEL -->
<div class="card" style="margin-bottom: 24px;">
  <h2>Title Details</h2>
  <div class="input-panel">
    <div class="field">
      <label for="retailPrice">Retail Price ($)</label>
      <input type="number" id="retailPrice" value="20" min="0.01" step="0.01">
    </div>
    <div class="field" style="grid-column: span 2;">
      <label>Vendor Discount (%)<span class="info-tip" title="The percentage off retail price the vendor offers you">?</span></label>
      <div class="slider-group">
        <input type="range" id="discountSlider" min="20" max="70" step="0.5" value="40">
        <input type="number" id="discountInput" min="20" max="70" step="0.5" value="40">
        <span>%</span>
      </div>
    </div>
    <div class="field">
      <label for="currentStock">Stock on Hand</label>
      <input type="number" id="currentStock" value="5" min="0" step="1">
    </div>
    <div class="field">
      <label for="weeklySales">Avg Weekly Sales<span class="info-tip" title="Average copies sold per week. Use decimals for slow sellers (e.g. 0.25 = 1 per month)">?</span></label>
      <input type="number" id="weeklySales" value="2" min="0" step="0.01">
    </div>
    <div class="field" style="grid-column: span 2;">
      <label>Order Quantity<span class="info-tip" title="Number of copies to order">?</span></label>
      <div class="slider-group">
        <input type="range" id="orderSlider" min="0" max="200" step="1" value="10">
        <input type="number" id="orderInput" min="0" max="200" step="1" value="10">
        <span>copies</span>
      </div>
    </div>
    <div class="field">
      <label for="leadTimeDays">Lead Time (days)<span class="info-tip" title="Number of days between placing an order and receiving the goods. Order quantity should cover demand during Reorder Cycle + Lead Time to avoid stockouts.">?</span></label>
      <input type="number" id="leadTimeDays" value="7" min="0" max="90" step="1">
    </div>
    <div class="field">
      <label for="paymentDays">Payment Terms<span class="info-tip" title="Number of days to pay the vendor invoice. Cash flow check compares sales revenue within this window vs order cost.">?</span></label>
      <input type="number" id="paymentDays" value="30" min="1" max="365" step="1">
    </div>
    <div class="field" style="grid-column: span 2;">
      <label>Reorder Every</label>
      <div class="slider-group">
        <input type="number" id="reorderVal" min="1" max="52" step="1" value="1" style="width:60px;">
        <select id="reorderUnit" style="width:auto;">
          <option value="7" selected>weeks</option>
          <option value="30">months</option>
          <option value="1">days</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- LEXICON -->
<div class="card" style="margin-bottom: 24px;">
  <div class="lexicon-toggle" id="lexiconToggle">
    <h2 style="margin-bottom: 0;">Lexicon</h2>
    <span class="toggle-arrow" id="toggleArrow">&#9660;</span>
  </div>
  <div class="lexicon-panel" id="lexiconPanel">
    <div class="lexicon-grid">
      <div class="lexicon-term">
        <h3>GMROII</h3>
        <p>Gross Margin Return on Inventory Investment. Measures how many dollars of gross margin you earn annually for each dollar tied up in inventory. GMROII = Markup &times; Stock Turn. A value above 2.0 is generally healthy; below 1.0 means your inventory costs more to carry than it earns.</p>
      </div>
      <div class="lexicon-term">
        <h3>GMROS (Discount)</h3>
        <p>Gross Margin Return on Sales &mdash; the vendor discount expressed as a margin on sales. If a vendor gives you 40% off retail, your margin on each sale is 40%. This is the &ldquo;profitability per sale&rdquo; half of GMROII; the other half is how fast you sell.</p>
      </div>
      <div class="lexicon-term">
        <h3>Stock Turn</h3>
        <p>How many times per year your average inventory sells through, measured at cost. Stock Turn = Annual COGS &divide; Avg Inventory at Cost. Higher turns mean your capital recycles faster, boosting GMROII even at lower margins.</p>
      </div>
      <div class="lexicon-term">
        <h3>Cost / Copy</h3>
        <p>Your net cost per copy (retail price minus discount) and the margin per copy. For a $20 book at 40% discount: cost = $12.00, margin = $8.00. This is the building block for all other calculations.</p>
      </div>
      <div class="lexicon-term">
        <h3>Markup</h3>
        <p>Margin per dollar invested in inventory: Discount / (1 &minus; Discount). At 40% discount, markup = 0.667, meaning you earn $0.667 for every $1.00 in cost. This is the &ldquo;profitability per dollar&rdquo; component of GMROII.</p>
      </div>
      <div class="lexicon-term">
        <h3>Avg Inventory</h3>
        <p>The average inventory at cost using a sawtooth model: (Stock on Hand + Order Qty / 2) &times; Cost per Copy. Represents the typical capital you have tied up in this title between reorders.</p>
      </div>
      <div class="lexicon-term">
        <h3>Annual Gross Margin</h3>
        <p>The estimated gross margin generated over a full year: GMROII &times; Avg Inventory at Cost. Equivalently: weekly sales &times; 52 &times; margin per copy. Shows the absolute dollar return, not just the rate of return.</p>
      </div>
      <div class="lexicon-term">
        <h3>Lead Time</h3>
        <p>The number of days between placing an order and receiving the goods. The order quantity must cover demand during both the reorder cycle and the lead time to prevent stockouts. Coverage = Reorder Cycle + Lead Time. A longer lead time requires a larger order or more safety stock.</p>
      </div>
      <div class="lexicon-term">
        <h3>Cash Flow</h3>
        <p>Compares expected sales revenue within your payment terms against the order cost. &ldquo;OK&rdquo; means sales cover the invoice on time. &ldquo;Warn&rdquo; means you need up to 2&times; payment terms. &ldquo;Bad&rdquo; means recovery takes even longer &mdash; you may need to fund the order from other cash flow.</p>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard">
  <!-- LEFT: Key Metrics -->
  <div class="metrics-panel" id="metricsPanel"></div>

  <!-- CENTER-TOP: Comparison Table -->
  <div class="card comparison-section">
    <h2>Order Quantity Comparison</h2>
    <table class="comparison-table">
      <thead>
        <tr>
          <th>Order Qty</th>
          <th>Coverage<span class="info-tip" title="How many days of demand this order + stock covers within the reorder cycle + lead time. 'OK' means full coverage; 'X of Y days' means stockout risk.">?</span></th>
          <th>Avg Inventory</th>
          <th>Stock Turn</th>
          <th>GMROII</th>
          <th>Annual Margin</th>
          <th>Days to Recover<span class="info-tip" title="How many days of sales revenue needed to pay off the order cost. Lower is better.">?</span></th>
        </tr>
      </thead>
      <tbody id="comparisonBody"></tbody>
    </table>
  </div>

  <!-- DISCOUNT STEP ADVISOR -->
  <div class="card advisor-section">
    <h2>Discount Step Advisor <span class="info-tip" title="Should you order more copies to reach the next discount tier? Uses the exact GMROII break-even formula based on your actual margin.">?</span></h2>
    <div class="advisor-grid">
      <div class="advisor-inputs">
        <div class="field">
          <label for="advCurrDiscount">Discount at Planned Qty (%)</label>
          <input type="number" id="advCurrDiscount" value="41" min="0" max="70" step="0.5">
        </div>
        <div class="field">
          <label for="advNextDiscount">Discount at Higher Tier (%)</label>
          <input type="number" id="advNextDiscount" value="42" min="0" max="70" step="0.5">
        </div>
        <div class="field">
          <label for="advCurrQty">Planned Order (copies)</label>
          <input type="number" id="advCurrQty" value="100" min="1" step="1">
        </div>
        <div class="field">
          <label for="advNextQty">Min. Copies for Higher Tier</label>
          <input type="number" id="advNextQty" value="104" min="1" step="1">
        </div>
      </div>
      <div class="advisor-result neutral" id="advisorResult">
        <div class="advisor-verdict" id="advisorVerdict">Enter values</div>
        <div class="advisor-explanation" id="advisorExplanation">Adjust the inputs to see whether stepping up to the next discount tier is worthwhile.</div>
      </div>
    </div>
  </div>

  <!-- Earning Power Chart -->
  <div class="card chart-section">
    <h2>Earning Power Decline <span class="info-tip" title="Shows how a copy's annualized earning power drops the longer it sits on the shelf">?</span></h2>
    <div class="chart-container" id="earningChart"></div>
    <p class="chart-title">Weeks in Store &rarr; Annualized GMROII per Copy</p>
  </div>
</div>

<script>
(function() {
  // --- DOM refs ---
  const $ = id => document.getElementById(id);
  const retailPrice   = $('retailPrice');
  const discountSlider = $('discountSlider');
  const discountInput  = $('discountInput');
  const currentStock  = $('currentStock');
  const weeklySales   = $('weeklySales');
  const orderSlider   = $('orderSlider');
  const orderInput    = $('orderInput');
  const leadTimeDays  = $('leadTimeDays');
  const paymentDays   = $('paymentDays');
  const reorderVal    = $('reorderVal');
  const reorderUnit   = $('reorderUnit');

  // Advisor refs
  const advCurrDiscount = $('advCurrDiscount');
  const advNextDiscount = $('advNextDiscount');
  const advCurrQty      = $('advCurrQty');
  const advNextQty      = $('advNextQty');

  // --- Sync sliders & inputs ---
  discountSlider.addEventListener('input', () => { discountInput.value = discountSlider.value; recalc(); });
  discountInput.addEventListener('input', () => { discountSlider.value = discountInput.value; recalc(); });
  orderSlider.addEventListener('input', () => { orderInput.value = orderSlider.value; recalc(); });
  orderInput.addEventListener('input', () => { orderSlider.value = orderInput.value; recalc(); });

  // --- Recalculate on any change ---
  const inputs = [retailPrice, discountSlider, discountInput, currentStock, weeklySales,
                  orderSlider, orderInput, leadTimeDays, paymentDays, reorderVal, reorderUnit];
  inputs.forEach(el => el.addEventListener('input', recalc));
  reorderUnit.addEventListener('change', recalc);

  const advisorInputs = [advCurrDiscount, advNextDiscount, advCurrQty, advNextQty];
  advisorInputs.forEach(el => el.addEventListener('input', recalcAdvisor));

  // --- Core calculations ---
  function getInputs() {
    return {
      price: parseFloat(retailPrice.value) || 0,
      discount: (parseFloat(discountInput.value) || 0) / 100,
      stock: parseInt(currentStock.value) || 0,
      salesPerWeek: parseFloat(weeklySales.value) || 0,
      orderQty: parseInt(orderInput.value) || 0,
      reorderDays: (parseInt(reorderVal.value) || 1) * (parseInt(reorderUnit.value) || 7),
      leadTimeDays: parseInt(leadTimeDays.value) || 0,
      paymentDays: parseInt(paymentDays.value) || 30
    };
  }

  function calcMetrics(inp, overrideOrderQty) {
    const qty = overrideOrderQty !== undefined ? overrideOrderQty : inp.orderQty;
    const d = inp.discount;
    const p = inp.price;
    const costPerCopy = p * (1 - d);
    const marginPerCopy = p * d;
    const marginPerDollar = d > 0 && d < 1 ? d / (1 - d) : 0;
    const gmros = d; // margin on sales is the discount percentage

    // Coverage must span reorder cycle + lead time
    // During lead time, no new stock arrives, so we need enough to cover both periods
    const leadTimeDays = inp.leadTimeDays || 0;
    const coverageDays = inp.reorderDays + leadTimeDays;
    const coverageWeeks = coverageDays / 7;
    const reorderWeeks = inp.reorderDays / 7;
    const demandPerCoverage = inp.salesPerWeek * coverageWeeks;
    const demandPerCycle = inp.salesPerWeek * reorderWeeks;

    const avgUnits = inp.stock + qty / 2;
    const avgInvAtCost = avgUnits * costPerCopy;

    // Coverage ratio: supply must cover demand during reorder cycle + lead time
    const supplyPerCycle = inp.stock + qty;
    const coverageRatio = demandPerCoverage > 0 ? Math.min(1, supplyPerCycle / demandPerCoverage) : 1;
    const effectiveSalesPerWeek = inp.salesPerWeek * coverageRatio;

    const annualSalesUnits = effectiveSalesPerWeek * 52;
    const stockTurn = avgInvAtCost > 0 ? (annualSalesUnits * costPerCopy) / avgInvAtCost : 0;

    const gmroii = marginPerDollar * stockTurn;
    const annualGrossMargin = avgInvAtCost > 0 ? gmroii * avgInvAtCost : 0;

    // Cash flow: can sales pay the invoice within payment terms?
    const payDays = inp.paymentDays;
    const revInTerm = inp.salesPerWeek * (payDays / 7) * p;
    const revDouble = inp.salesPerWeek * (payDays * 2 / 7) * p;
    const orderCost = qty * costPerCopy;

    let cashflow = 'ok';
    let cashflowText = `Sales cover invoice within ${payDays} days`;
    if (orderCost > 0) {
      if (revInTerm >= orderCost) {
        cashflow = 'ok';
        cashflowText = `Sales cover invoice within ${payDays} days`;
      } else if (revDouble >= orderCost) {
        cashflow = 'warn';
        cashflowText = `Sales cover invoice in ${payDays}\u2013${payDays * 2} days`;
      } else {
        cashflow = 'bad';
        const daysToRecover = inp.salesPerWeek > 0 ? Math.ceil((orderCost / (inp.salesPerWeek * p)) * 7) : Infinity;
        cashflowText = daysToRecover === Infinity
          ? 'No sales to recover cost'
          : `~${daysToRecover} days to recover order cost`;
      }
    } else {
      cashflowText = 'No order placed';
    }

    return {
      costPerCopy, marginPerCopy, marginPerDollar, gmros,
      avgUnits, avgInvAtCost, stockTurn, gmroii, annualGrossMargin,
      cashflow, cashflowText, orderCost,
      coverageRatio, demandPerCoverage, coverageDays, effectiveSalesPerWeek
    };
  }

  // --- Render metrics panel ---
  function renderMetrics(m, inp) {
    const panel = $('metricsPanel');
    const gmroiiClass = m.gmroii >= 2 ? 'positive' : m.gmroii >= 1 ? '' : 'negative';
    const p = inp.price;
    const d = inp.discount;
    const annualCOGS = (m.effectiveSalesPerWeek * 52 * m.costPerCopy);
    const coverageNote = m.coverageRatio < 1
      ? `<div class="metric-formula" style="background:var(--red-light); color:var(--red);">&#9888; Stock + order covers only ${Math.round(m.coverageRatio * m.coverageDays)} of ${m.coverageDays} days (reorder ${inp.reorderDays}d + lead time ${inp.leadTimeDays}d). Effective sales: ${m.effectiveSalesPerWeek.toFixed(2)}/wk (was ${inp.salesPerWeek}/wk)</div>`
      : '';
    const revInTerm = inp.salesPerWeek * (inp.paymentDays/7) * p;
    panel.innerHTML = `
      <div class="metric-card highlight">
        <div class="metric-label">GMROII</div>
        <div class="metric-value">${m.gmroii.toFixed(2)}</div>
        <div class="metric-sub">$ earned per $ invested/yr</div>
        <div class="metric-formula">${m.marginPerDollar.toFixed(3)} &times; ${m.stockTurn.toFixed(1)} = ${m.gmroii.toFixed(2)}<br>markup &times; stock turn</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">GMROS (Discount)</div>
        <div class="metric-value">${(m.gmros * 100).toFixed(1)}%</div>
        <div class="metric-sub">Margin on sales</div>
        <div class="metric-formula">$${m.marginPerCopy.toFixed(2)} / $${p.toFixed(2)} = ${(m.gmros * 100).toFixed(1)}%<br>margin per copy / retail price</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Stock Turn</div>
        <div class="metric-value">${m.stockTurn.toFixed(1)}</div>
        <div class="metric-sub">Annual inventory turns</div>
        <div class="metric-formula">${m.effectiveSalesPerWeek.toFixed(2)}&times;52&times;$${m.costPerCopy.toFixed(2)} / $${m.avgInvAtCost.toFixed(0)} = ${m.stockTurn.toFixed(1)}<br>annual COGS / avg inventory at cost</div>
        ${coverageNote}
      </div>
      <div class="metric-card">
        <div class="metric-label">Cost / Copy</div>
        <div class="metric-value">$${m.costPerCopy.toFixed(2)}</div>
        <div class="metric-sub">Margin: $${m.marginPerCopy.toFixed(2)}</div>
        <div class="metric-formula">$${p.toFixed(2)} &times; (1 &minus; ${(d*100).toFixed(1)}%) = $${m.costPerCopy.toFixed(2)}<br>$${p.toFixed(2)} &times; ${(d*100).toFixed(1)}% = $${m.marginPerCopy.toFixed(2)} margin</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Markup (margin per $ invested)</div>
        <div class="metric-value">${m.marginPerDollar.toFixed(3)}</div>
        <div class="metric-sub">discount / (1 &minus; discount)</div>
        <div class="metric-formula">${(d*100).toFixed(1)}% / ${((1-d)*100).toFixed(1)}% = ${m.marginPerDollar.toFixed(3)}<br>or: $${m.marginPerCopy.toFixed(2)} / $${m.costPerCopy.toFixed(2)}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Avg Inventory (cost)</div>
        <div class="metric-value">$${m.avgInvAtCost.toFixed(0)}</div>
        <div class="metric-sub">${m.avgUnits.toFixed(1)} units on avg</div>
        <div class="metric-formula">(${inp.stock} + ${inp.orderQty}/2) &times; $${m.costPerCopy.toFixed(2)} = $${m.avgInvAtCost.toFixed(0)}<br>(stock + order/2) &times; cost per copy</div>
      </div>
      <div class="metric-card ${gmroiiClass}">
        <div class="metric-label">Annual Gross Margin</div>
        <div class="metric-value">$${m.annualGrossMargin.toFixed(0)}</div>
        <div class="metric-sub">GMROII &times; avg inv at cost</div>
        <div class="metric-formula">${m.gmroii.toFixed(2)} &times; $${m.avgInvAtCost.toFixed(0)} = $${m.annualGrossMargin.toFixed(0)}<br>or: ${m.effectiveSalesPerWeek.toFixed(2)} &times; 52 &times; $${m.marginPerCopy.toFixed(2)} = $${m.annualGrossMargin.toFixed(0)}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Cash Flow</div>
        <div class="metric-value cashflow-${m.cashflow}" style="font-size:1rem;">${m.cashflowText}</div>
        <div class="metric-sub">Order cost: $${m.orderCost.toFixed(0)}</div>
        <div class="metric-formula">${inp.salesPerWeek} &times; ${(inp.paymentDays/7).toFixed(1)}wk &times; $${p.toFixed(2)} = $${revInTerm.toFixed(0)} rev/${inp.paymentDays}d<br>vs order: ${inp.orderQty} &times; $${m.costPerCopy.toFixed(2)} = $${m.orderCost.toFixed(0)}</div>
      </div>
    `;
  }

  // --- Comparison table ---
  function renderComparison(inp) {
    // Minimum coverage qty: must cover reorder cycle + lead time
    const coverageDays = inp.reorderDays + (inp.leadTimeDays || 0);
    const coverageWeeks = coverageDays / 7;
    const minCoverageQty = Math.max(0, Math.ceil(inp.salesPerWeek * coverageWeeks) - inp.stock);

    const qtys = [0, 1, 3, 5, 10, 25, 50, 100];
    // Add the minimum coverage qty as a suggested option
    if (minCoverageQty > 0 && !qtys.includes(minCoverageQty)) {
      qtys.push(minCoverageQty);
    }
    if (!qtys.includes(inp.orderQty)) {
      qtys.push(inp.orderQty);
    }
    qtys.sort((a, b) => a - b);

    let bestGmroii = -Infinity;
    let bestQty = 0;
    const rows = qtys.map(q => {
      const m = calcMetrics(inp, q);
      // Best = highest GMROII among quantities that provide full coverage
      const coversNeeds = m.coverageRatio >= 1;
      if (m.gmroii > bestGmroii && q > 0 && coversNeeds) { bestGmroii = m.gmroii; bestQty = q; }
      return { q, m };
    });

    // If no qty with full coverage found, fall back to best GMROII overall
    if (bestGmroii === -Infinity) {
      rows.forEach(({ q, m }) => {
        if (m.gmroii > bestGmroii && q > 0) { bestGmroii = m.gmroii; bestQty = q; }
      });
    }

    // If stock > 0 and orderQty = 0, that row may have the best GMROII
    const m0 = calcMetrics(inp, 0);
    if (m0.gmroii > bestGmroii && inp.stock > 0 && m0.coverageRatio >= 1) { bestGmroii = m0.gmroii; bestQty = 0; }

    const tbody = $('comparisonBody');
    // Find the peak GMROII index to flag rows past the peak as suboptimal
    let peakIdx = rows.findIndex(r => r.q === bestQty);

    tbody.innerHTML = rows.map(({ q, m }, idx) => {
      const isCurrent = q === inp.orderQty;
      const isOptimal = q === bestQty && q !== inp.orderQty;
      const isPastPeak = idx > peakIdx && q > bestQty && m.gmroii < bestGmroii;
      let cls = isCurrent ? 'current' : isOptimal ? 'optimal' : '';
      if (isPastPeak && !isCurrent) cls = 'suboptimal';
      const tags = (isCurrent ? '<span class="tag tag-current">current</span>' : '') +
                   (isOptimal ? '<span class="tag tag-optimal">best</span>' : '') +
                   (q === bestQty && isCurrent ? '<span class="tag tag-optimal">best</span>' : '') +
                   (isPastPeak ? '<span class="tag tag-suboptimal">overstock</span>' : '');
      const annCOGS = m.effectiveSalesPerWeek * 52 * m.costPerCopy;
      const covDays = Math.round(m.coverageRatio * coverageDays);
      const covCell = m.coverageRatio >= 1
        ? '<span class="coverage-full">OK</span>'
        : `<span class="coverage-short">${covDays} of ${coverageDays}d</span>`;

      // Days to recover order cost
      let recoverCell;
      if (q === 0) {
        recoverCell = '&mdash;';
      } else if (inp.salesPerWeek <= 0) {
        recoverCell = '<span class="coverage-short">&infin;</span>';
      } else {
        const daysToRecover = Math.ceil((m.orderCost / (inp.salesPerWeek * inp.price)) * 7);
        const recoverClass = daysToRecover <= 30 ? 'coverage-full' : daysToRecover <= 60 ? '' : 'coverage-short';
        recoverCell = `<span class="${recoverClass}">${daysToRecover}d</span>`;
      }

      return `<tr class="${cls}">
        <td>${q}${tags}</td>
        <td>${covCell}</td>
        <td>${m.avgUnits.toFixed(1)} units<span class="formula">${inp.stock}+${q}/2 = ${m.avgUnits.toFixed(1)}</span></td>
        <td>${m.stockTurn.toFixed(1)}<span class="formula">${annCOGS.toFixed(0)}/${m.avgInvAtCost.toFixed(0)}</span></td>
        <td>${m.gmroii.toFixed(2)}<span class="formula">${m.marginPerDollar.toFixed(3)}&times;${m.stockTurn.toFixed(1)}</span></td>
        <td>$${m.annualGrossMargin.toFixed(0)}<span class="formula">${m.gmroii.toFixed(2)}&times;${m.avgInvAtCost.toFixed(0)}</span></td>
        <td>${recoverCell}</td>
      </tr>`;
    }).join('');
  }

  // --- Earning Power Decline chart ---
  function renderEarningChart(inp) {
    const container = $('earningChart');
    const d = inp.discount;
    const marginPerDollar = d > 0 && d < 1 ? d / (1 - d) : 0;

    const weeks = [1, 2, 3, 4, 6, 8, 10, 13, 16, 20, 26, 39, 52];
    const values = weeks.map(w => marginPerDollar * (52 / w));
    const maxVal = Math.max(...values, 1);
    const n = weeks.length;

    // SVG dimensions
    const W = 500, H = 180;
    const pad = { top: 24, right: 16, bottom: 30, left: 42 };
    const plotW = W - pad.left - pad.right;
    const plotH = H - pad.top - pad.bottom;
    const barGap = 3;
    const barW = (plotW - barGap * (n - 1)) / n;

    const yScale = v => pad.top + plotH - (v / maxVal) * plotH;
    const baseline = pad.top + plotH;

    // Grid lines & Y labels
    const ySteps = 4;
    let gridHtml = '';
    for (let i = 0; i <= ySteps; i++) {
      const val = (maxVal / ySteps) * i;
      const y = yScale(val);
      gridHtml += `<line x1="${pad.left}" y1="${y}" x2="${W - pad.right}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
      gridHtml += `<text x="${pad.left - 6}" y="${y + 3}" text-anchor="end" fill="var(--muted)" font-size="9">${val.toFixed(1)}</text>`;
    }

    // Bars + labels
    let barsHtml = '';
    weeks.forEach((w, i) => {
      const x = pad.left + i * (barW + barGap);
      const barH = (values[i] / maxVal) * plotH;
      const y = baseline - barH;
      const hue = Math.max(0, 120 - (i / (n - 1)) * 120);
      const color = `hsl(${hue}, 70%, 50%)`;
      const colorDark = `hsl(${hue}, 70%, 40%)`;
      barsHtml += `<rect x="${x}" y="${y}" width="${barW}" height="${barH}" fill="${color}" rx="2"/>`;
      barsHtml += `<text x="${x + barW / 2}" y="${y - 3}" text-anchor="middle" fill="${colorDark}" font-size="7.5" font-weight="600">${values[i].toFixed(1)}</text>`;
      barsHtml += `<text x="${x + barW / 2}" y="${baseline + 12}" text-anchor="middle" fill="var(--muted)" font-size="7.5">${w}w</text>`;
    });

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${gridHtml}
        ${barsHtml}
      </svg>`;
  }

  // --- Discount Step Advisor ---
  function recalcAdvisor() {
    const dCurr = (parseFloat(advCurrDiscount.value) || 0) / 100;
    const dNext = (parseFloat(advNextDiscount.value) || 0) / 100;
    const qCurr = parseInt(advCurrQty.value) || 0;
    const qNext = parseInt(advNextQty.value) || 0;

    const resultDiv = $('advisorResult');
    const verdictDiv = $('advisorVerdict');
    const explDiv = $('advisorExplanation');

    if (dNext <= dCurr || qNext <= qCurr || dCurr <= 0 || dCurr >= 1) {
      resultDiv.className = 'advisor-result neutral';
      verdictDiv.textContent = 'Check inputs';
      explDiv.textContent = 'Next tier discount must be higher than current, and next tier quantity must be larger.';
      return;
    }

    // Exact GMROII break-even formula:
    // GMROII = markup × inventory_turnover = [D/(1-D)] × turn
    // Turnover is inversely proportional to qty (same sales rate, more stock).
    // To maintain GMROII: (D2/(1-D2)) × (Q1/Q2) >= (D1/(1-D1))
    // => max Q2/Q1 = (D2/(1-D2)) / (D1/(1-D1)) = markup_new / markup_old
    const markupCurr = dCurr / (1 - dCurr);
    const markupNext = dNext / (1 - dNext);
    const allowableIncreaseRatio = markupNext / markupCurr;
    const allowableIncreasePct = (allowableIncreaseRatio - 1) * 100;

    const discountGainPct = (dNext - dCurr) * 100;
    const qtyIncreasePct = ((qNext - qCurr) / qCurr) * 100;
    const marginGainPct = ((markupNext - markupCurr) / markupCurr) * 100;

    // Shatzkin's fixed 4% rule comparison
    const shatzkinAllowable = discountGainPct * 4;
    const shatzkinDiff = allowableIncreasePct - shatzkinAllowable;
    const shatzkinNote = Math.abs(shatzkinDiff) > 0.1
      ? ` Shatzkin's fixed 4% rule would say <strong>~${shatzkinAllowable.toFixed(1)}%</strong> &mdash; ${shatzkinDiff > 0 ? 'too conservative' : 'too generous'} at your margin level.`
      : '';

    const worthIt = qtyIncreasePct <= allowableIncreasePct;

    if (worthIt) {
      resultDiv.className = 'advisor-result worth-it';
      verdictDiv.textContent = 'Worth it';
      explDiv.innerHTML = `At <strong>${(dCurr*100).toFixed(1)}%</strong> margin, the <strong>+${discountGainPct.toFixed(1)} pp</strong> discount gain allows up to <strong>+${allowableIncreasePct.toFixed(1)}%</strong> more copies (exact markup ratio). ` +
        `You need <strong>+${qtyIncreasePct.toFixed(1)}%</strong> more &mdash; within the allowable range. ` +
        `Markup improves from <strong>${markupCurr.toFixed(3)}</strong> to <strong>${markupNext.toFixed(3)}</strong> (+${marginGainPct.toFixed(1)}%).` +
        shatzkinNote;
    } else {
      resultDiv.className = 'advisor-result not-worth-it';
      verdictDiv.textContent = 'Not worth it';
      explDiv.innerHTML = `At <strong>${(dCurr*100).toFixed(1)}%</strong> margin, the <strong>+${discountGainPct.toFixed(1)} pp</strong> discount gain allows up to <strong>+${allowableIncreasePct.toFixed(1)}%</strong> more copies (exact markup ratio). ` +
        `But you need <strong>+${qtyIncreasePct.toFixed(1)}%</strong> more &mdash; exceeds the break-even threshold. ` +
        `The extra inventory cost outweighs the margin improvement. ` +
        `Markup goes from <strong>${markupCurr.toFixed(3)}</strong> to <strong>${markupNext.toFixed(3)}</strong> (+${marginGainPct.toFixed(1)}%).` +
        shatzkinNote;
    }
  }

  // --- Master recalc ---
  function recalc() {
    const inp = getInputs();
    const m = calcMetrics(inp);
    renderMetrics(m, inp);
    renderComparison(inp);
    renderEarningChart(inp);
  }

  // --- Lexicon toggle ---
  const lexiconToggle = $('lexiconToggle');
  const lexiconPanel = $('lexiconPanel');
  const toggleArrow = $('toggleArrow');
  lexiconToggle.addEventListener('click', () => {
    lexiconPanel.classList.toggle('open');
    toggleArrow.classList.toggle('open');
  });

  // --- Init ---
  recalc();
  recalcAdvisor();
})();
</script>
</body>
</html>
