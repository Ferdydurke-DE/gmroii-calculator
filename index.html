<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GMROII &amp; GMROS Calculator for Booksellers</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f4f6f9;
  --card: #ffffff;
  --border: #dce1e8;
  --text: #1a2332;
  --muted: #5a6a7e;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --green: #16a34a;
  --green-light: #dcfce7;
  --red: #dc2626;
  --red-light: #fee2e2;
  --orange: #ea580c;
  --orange-light: #ffedd5;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.subtitle {
  color: var(--muted);
  font-size: 0.875rem;
  margin-bottom: 24px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
}

.card h2 {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 16px;
  font-weight: 600;
}

/* Input Panel */
.input-panel {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.field label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  margin-bottom: 6px;
}

.field input[type="text"],
.field input[type="number"],
.field select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.95rem;
  color: var(--text);
  background: #fff;
  transition: border-color 0.15s;
}

.field input:focus, .field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.slider-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.slider-group input[type="range"] {
  flex: 1;
  accent-color: var(--accent);
  cursor: pointer;
}

.slider-group input[type="number"] {
  width: 70px;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: center;
}

.slider-group input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

/* Dashboard Grid */
.dashboard {
  display: grid;
  grid-template-columns: 280px 1fr;
  grid-template-rows: auto auto;
  gap: 20px;
  margin-bottom: 24px;
}

/* Key Metrics */
.metrics-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  grid-row: 1 / 3;
}

.metric-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}

.metric-card .metric-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  font-weight: 600;
}

.metric-card .metric-value {
  font-size: 1.8rem;
  font-weight: 700;
  margin-top: 4px;
  line-height: 1.2;
}

.metric-card .metric-sub {
  font-size: 0.78rem;
  color: var(--muted);
  margin-top: 2px;
}

.metric-card.highlight {
  border-color: var(--accent);
  background: linear-gradient(135deg, var(--accent-light) 0%, #fff 100%);
}

.metric-card.highlight .metric-value { color: var(--accent); }

.metric-card.positive .metric-value { color: var(--green); }
.metric-card.negative .metric-value { color: var(--red); }

.cashflow-ok { color: var(--green); font-weight: 600; }
.cashflow-warn { color: var(--orange); font-weight: 600; }
.cashflow-bad { color: var(--red); font-weight: 600; }

/* Comparison Table */
.comparison-section { grid-column: 2; }

.comparison-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.comparison-table th {
  text-align: left;
  padding: 8px 12px;
  border-bottom: 2px solid var(--border);
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--muted);
  font-weight: 600;
}

.comparison-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}

.comparison-table tr.optimal {
  background: var(--green-light);
  font-weight: 600;
}

.comparison-table tr.current {
  background: var(--accent-light);
}

.comparison-table tr:hover {
  background: #f0f4ff;
}

.tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 6px;
}

.tag-optimal { background: var(--green-light); color: var(--green); }
.tag-current { background: var(--accent-light); color: var(--accent); }

/* Chart Section */
.chart-section {
  grid-column: 2;
}

.chart-container {
  position: relative;
  height: 220px;
  display: flex;
  align-items: flex-end;
  gap: 2px;
  padding: 20px 0 30px 50px;
}

.chart-y-axis {
  position: absolute;
  left: 0;
  top: 20px;
  bottom: 30px;
  width: 46px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: flex-end;
  padding-right: 6px;
}

.chart-y-axis span {
  font-size: 0.65rem;
  color: var(--muted);
}

.bar-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  justify-content: flex-end;
  min-width: 0;
}

.bar {
  width: 80%;
  max-width: 40px;
  border-radius: 3px 3px 0 0;
  transition: height 0.3s ease;
  min-height: 2px;
  position: relative;
}

.bar-label {
  font-size: 0.6rem;
  color: var(--muted);
  margin-top: 4px;
  white-space: nowrap;
  text-align: center;
}

.bar-value {
  position: absolute;
  top: -16px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 0.6rem;
  font-weight: 600;
  white-space: nowrap;
}

.chart-title {
  font-size: 0.75rem;
  color: var(--muted);
  text-align: center;
  margin-top: 8px;
}

/* Discount Step Advisor */
.advisor-section {
  margin-bottom: 24px;
}

.advisor-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.advisor-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.advisor-result {
  padding: 16px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.advisor-result.worth-it {
  background: var(--green-light);
  border-color: #86efac;
}

.advisor-result.not-worth-it {
  background: var(--red-light);
  border-color: #fca5a5;
}

.advisor-result.neutral {
  background: var(--orange-light);
  border-color: #fdba74;
}

.advisor-verdict {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 6px;
}

.advisor-explanation {
  font-size: 0.82rem;
  color: var(--text);
  line-height: 1.5;
}

/* Responsive */
@media (max-width: 900px) {
  .dashboard {
    grid-template-columns: 1fr;
  }
  .metrics-panel {
    grid-row: auto;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .metric-card { flex: 1; min-width: 140px; }
  .comparison-section, .chart-section { grid-column: 1; }
  .advisor-grid { grid-template-columns: 1fr; }
}

@media (max-width: 600px) {
  body { padding: 12px; }
  .input-panel { grid-template-columns: 1fr 1fr; }
}

.info-tip {
  display: inline-block;
  width: 15px;
  height: 15px;
  line-height: 15px;
  text-align: center;
  border-radius: 50%;
  background: var(--border);
  color: var(--muted);
  font-size: 0.6rem;
  font-weight: 700;
  cursor: help;
  margin-left: 4px;
  vertical-align: middle;
}
</style>
</head>
<body>

<h1>GMROII &amp; GMROS Calculator</h1>
<p class="subtitle">Restocking decisions guided by Gross Margin Return on Inventory Investment &mdash; based on Shatzkin's <em>The Mathematics of Bookselling</em></p>

<!-- INPUT PANEL -->
<div class="card" style="margin-bottom: 24px;">
  <h2>Title Details</h2>
  <div class="input-panel">
    <div class="field" style="grid-column: span 2;">
      <label for="titleName">Title Name</label>
      <input type="text" id="titleName" value="Sample Book" placeholder="Enter title...">
    </div>
    <div class="field">
      <label for="retailPrice">Retail Price ($)</label>
      <input type="number" id="retailPrice" value="20" min="0.01" step="0.01">
    </div>
    <div class="field" style="grid-column: span 2;">
      <label>Vendor Discount (%)<span class="info-tip" title="The percentage off retail price the vendor offers you">?</span></label>
      <div class="slider-group">
        <input type="range" id="discountSlider" min="20" max="70" step="0.5" value="40">
        <input type="number" id="discountInput" min="20" max="70" step="0.5" value="40">
        <span>%</span>
      </div>
    </div>
    <div class="field">
      <label for="currentStock">Stock on Hand</label>
      <input type="number" id="currentStock" value="5" min="0" step="1">
    </div>
    <div class="field">
      <label for="weeklySales">Avg Weekly Sales<span class="info-tip" title="Average copies sold per week. Use decimals for slow sellers (e.g. 0.25 = 1 per month)">?</span></label>
      <input type="number" id="weeklySales" value="2" min="0" step="0.01">
    </div>
    <div class="field" style="grid-column: span 2;">
      <label>Order Quantity<span class="info-tip" title="Number of copies to order">?</span></label>
      <div class="slider-group">
        <input type="range" id="orderSlider" min="0" max="200" step="1" value="10">
        <input type="number" id="orderInput" min="0" max="200" step="1" value="10">
        <span>copies</span>
      </div>
    </div>
    <div class="field">
      <label for="reorderFreq">Reorder Frequency</label>
      <select id="reorderFreq">
        <option value="1">Daily</option>
        <option value="3">Every 3 Days</option>
        <option value="7" selected>Weekly</option>
        <option value="14">Biweekly</option>
        <option value="30">Monthly</option>
      </select>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard">
  <!-- LEFT: Key Metrics -->
  <div class="metrics-panel" id="metricsPanel"></div>

  <!-- CENTER-TOP: Comparison Table -->
  <div class="card comparison-section">
    <h2>Order Quantity Comparison</h2>
    <table class="comparison-table">
      <thead>
        <tr>
          <th>Order Qty</th>
          <th>Avg Inventory</th>
          <th>Stock Turn</th>
          <th>GMROII</th>
          <th>Annual Margin</th>
        </tr>
      </thead>
      <tbody id="comparisonBody"></tbody>
    </table>
  </div>

  <!-- CENTER-BOTTOM: Earning Power Chart -->
  <div class="card chart-section">
    <h2>Earning Power Decline <span class="info-tip" title="Shows how a copy's annualized earning power drops the longer it sits on the shelf">?</span></h2>
    <p style="font-size:0.82rem; color:var(--muted); margin-bottom:12px;">Annualized GMROII asks: <em>if a single copy sits on the shelf for W weeks and then sells, what would its return on investment be projected over a full year?</em> A copy sold in week 1 earns its margin 52 times over (annualized); a copy that takes 26 weeks to sell only earns it twice. The faster a copy sells, the harder your invested dollar works.</p>
    <div class="chart-container" id="earningChart"></div>
    <p class="chart-title">Weeks in Store &rarr; Annualized GMROII per Copy</p>
  </div>
</div>

<!-- DISCOUNT STEP ADVISOR -->
<div class="card advisor-section">
  <h2>Discount Step Advisor <span class="info-tip" title="Should you order more copies to reach the next discount tier? Uses the 4% rule from Shatzkin.">?</span></h2>
  <p style="font-size:0.82rem; color:var(--muted); margin-bottom:16px;">You planned to order a certain number of copies at your current discount. The vendor offers a higher discount if you order more. Is the extra discount worth the extra copies?</p>
  <div class="advisor-grid">
    <div class="advisor-inputs">
      <div class="field">
        <label for="advCurrDiscount">Discount at Planned Qty (%)</label>
        <input type="number" id="advCurrDiscount" value="41" min="0" max="70" step="0.5">
      </div>
      <div class="field">
        <label for="advNextDiscount">Discount at Higher Tier (%)</label>
        <input type="number" id="advNextDiscount" value="42" min="0" max="70" step="0.5">
      </div>
      <div class="field">
        <label for="advCurrQty">Planned Order (copies)</label>
        <input type="number" id="advCurrQty" value="100" min="1" step="1">
      </div>
      <div class="field">
        <label for="advNextQty">Min. Copies for Higher Tier</label>
        <input type="number" id="advNextQty" value="104" min="1" step="1">
      </div>
    </div>
    <div class="advisor-result neutral" id="advisorResult">
      <div class="advisor-verdict" id="advisorVerdict">Enter values</div>
      <div class="advisor-explanation" id="advisorExplanation">Adjust the inputs to see whether stepping up to the next discount tier is worthwhile.</div>
    </div>
  </div>
</div>

<script>
(function() {
  // --- DOM refs ---
  const $ = id => document.getElementById(id);
  const titleName     = $('titleName');
  const retailPrice   = $('retailPrice');
  const discountSlider = $('discountSlider');
  const discountInput  = $('discountInput');
  const currentStock  = $('currentStock');
  const weeklySales   = $('weeklySales');
  const orderSlider   = $('orderSlider');
  const orderInput    = $('orderInput');
  const reorderFreq   = $('reorderFreq');

  // Advisor refs
  const advCurrDiscount = $('advCurrDiscount');
  const advNextDiscount = $('advNextDiscount');
  const advCurrQty      = $('advCurrQty');
  const advNextQty      = $('advNextQty');

  // --- Sync sliders & inputs ---
  discountSlider.addEventListener('input', () => { discountInput.value = discountSlider.value; recalc(); });
  discountInput.addEventListener('input', () => { discountSlider.value = discountInput.value; recalc(); });
  orderSlider.addEventListener('input', () => { orderInput.value = orderSlider.value; recalc(); });
  orderInput.addEventListener('input', () => { orderSlider.value = orderInput.value; recalc(); });

  // --- Recalculate on any change ---
  const inputs = [titleName, retailPrice, discountSlider, discountInput, currentStock, weeklySales,
                  orderSlider, orderInput, reorderFreq];
  inputs.forEach(el => el.addEventListener('input', recalc));
  reorderFreq.addEventListener('change', recalc);

  const advisorInputs = [advCurrDiscount, advNextDiscount, advCurrQty, advNextQty];
  advisorInputs.forEach(el => el.addEventListener('input', recalcAdvisor));

  // --- Core calculations ---
  function getInputs() {
    return {
      price: parseFloat(retailPrice.value) || 0,
      discount: (parseFloat(discountInput.value) || 0) / 100,
      stock: parseInt(currentStock.value) || 0,
      salesPerWeek: parseFloat(weeklySales.value) || 0,
      orderQty: parseInt(orderInput.value) || 0,
      reorderDays: parseInt(reorderFreq.value) || 7
    };
  }

  function calcMetrics(inp, overrideOrderQty) {
    const qty = overrideOrderQty !== undefined ? overrideOrderQty : inp.orderQty;
    const d = inp.discount;
    const p = inp.price;
    const costPerCopy = p * (1 - d);
    const marginPerCopy = p * d;
    const marginPerDollar = d > 0 && d < 1 ? d / (1 - d) : 0;
    const gmros = d; // margin on sales is the discount percentage

    // Average inventory calculation using reorder cycle
    // During a cycle of `reorderDays` days, stock depletes from (stock + qty) to stock.
    // Average units on shelf = stock + qty/2 (sawtooth pattern)
    const reorderWeeks = inp.reorderDays / 7;
    const demandPerCycle = inp.salesPerWeek * reorderWeeks;

    // More realistic: if we order `qty` every cycle, average inventory in units
    // is the mean of start-of-cycle and end-of-cycle stock.
    // Start = current_stock + qty (just received), End = current_stock + qty - demandPerCycle
    // But simplified: avg_units = qty / 2 + max(stock - demandPerCycle/2, 0)
    // We use a practical model: avg_units = stock + qty / 2
    // This assumes stock on hand is the baseline and orders replenish on top.
    const avgUnits = inp.stock + qty / 2;
    const avgInvAtCost = avgUnits * costPerCopy;

    const annualSalesUnits = inp.salesPerWeek * 52;
    const stockTurn = avgInvAtCost > 0 ? (annualSalesUnits * costPerCopy) / avgInvAtCost : 0;

    const gmroii = marginPerDollar * stockTurn;
    const annualGrossMargin = avgInvAtCost > 0 ? gmroii * avgInvAtCost : 0;

    // Cash flow: can sales pay invoices in 30/60 days?
    // Revenue in 30 days = salesPerWeek * (30/7) * price
    // Cost of order = qty * costPerCopy
    const rev30 = inp.salesPerWeek * (30 / 7) * p;
    const rev60 = inp.salesPerWeek * (60 / 7) * p;
    const orderCost = qty * costPerCopy;

    let cashflow = 'ok';
    let cashflowText = 'Sales cover invoice within 30 days';
    if (orderCost > 0) {
      if (rev30 >= orderCost) {
        cashflow = 'ok';
        cashflowText = 'Sales cover invoice within 30 days';
      } else if (rev60 >= orderCost) {
        cashflow = 'warn';
        cashflowText = 'Sales cover invoice in 30\u201360 days';
      } else {
        cashflow = 'bad';
        const daysToRecover = inp.salesPerWeek > 0 ? Math.ceil((orderCost / (inp.salesPerWeek * p)) * 7) : Infinity;
        cashflowText = daysToRecover === Infinity
          ? 'No sales to recover cost'
          : `~${daysToRecover} days to recover order cost`;
      }
    } else {
      cashflowText = 'No order placed';
    }

    return {
      costPerCopy, marginPerCopy, marginPerDollar, gmros,
      avgUnits, avgInvAtCost, stockTurn, gmroii, annualGrossMargin,
      cashflow, cashflowText, orderCost
    };
  }

  // --- Render metrics panel ---
  function renderMetrics(m) {
    const panel = $('metricsPanel');
    const gmroiiClass = m.gmroii >= 2 ? 'positive' : m.gmroii >= 1 ? '' : 'negative';
    panel.innerHTML = `
      <div class="metric-card highlight">
        <div class="metric-label">GMROII</div>
        <div class="metric-value">${m.gmroii.toFixed(2)}</div>
        <div class="metric-sub">$ earned per $ invested/yr</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">GMROS (Discount)</div>
        <div class="metric-value">${(m.gmros * 100).toFixed(1)}%</div>
        <div class="metric-sub">Margin on sales</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Stock Turn</div>
        <div class="metric-value">${m.stockTurn.toFixed(1)}</div>
        <div class="metric-sub">Annual inventory turns</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Cost / Copy</div>
        <div class="metric-value">$${m.costPerCopy.toFixed(2)}</div>
        <div class="metric-sub">Margin: $${m.marginPerCopy.toFixed(2)}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Margin per $ Invested</div>
        <div class="metric-value">${m.marginPerDollar.toFixed(3)}</div>
        <div class="metric-sub">discount / (1 - discount)</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Avg Inventory (cost)</div>
        <div class="metric-value">$${m.avgInvAtCost.toFixed(0)}</div>
        <div class="metric-sub">${m.avgUnits.toFixed(1)} units on avg</div>
      </div>
      <div class="metric-card ${gmroiiClass}">
        <div class="metric-label">Annual Gross Margin</div>
        <div class="metric-value">$${m.annualGrossMargin.toFixed(0)}</div>
        <div class="metric-sub">GMROII &times; avg inv at cost</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Cash Flow</div>
        <div class="metric-value cashflow-${m.cashflow}" style="font-size:1rem;">${m.cashflowText}</div>
        <div class="metric-sub">Order cost: $${m.orderCost.toFixed(0)}</div>
      </div>
    `;
  }

  // --- Comparison table ---
  function renderComparison(inp) {
    const qtys = [0, 1, 3, 5, 10, 25, 50, 100];
    if (!qtys.includes(inp.orderQty)) {
      qtys.push(inp.orderQty);
      qtys.sort((a, b) => a - b);
    }

    let bestGmroii = -Infinity;
    let bestQty = 0;
    const rows = qtys.map(q => {
      const m = calcMetrics(inp, q);
      if (m.gmroii > bestGmroii && q > 0) { bestGmroii = m.gmroii; bestQty = q; }
      return { q, m };
    });

    // If stock > 0 and orderQty = 0, that row may have the best GMROII
    const m0 = calcMetrics(inp, 0);
    if (m0.gmroii > bestGmroii && inp.stock > 0) { bestGmroii = m0.gmroii; bestQty = 0; }

    const tbody = $('comparisonBody');
    tbody.innerHTML = rows.map(({ q, m }) => {
      const isCurrent = q === inp.orderQty;
      const isOptimal = q === bestQty && q !== inp.orderQty;
      const cls = isCurrent ? 'current' : isOptimal ? 'optimal' : '';
      const tags = (isCurrent ? '<span class="tag tag-current">current</span>' : '') +
                   (isOptimal ? '<span class="tag tag-optimal">best</span>' : '') +
                   (q === bestQty && isCurrent ? '<span class="tag tag-optimal">best</span>' : '');
      return `<tr class="${cls}">
        <td>${q}${tags}</td>
        <td>${m.avgUnits.toFixed(1)} units</td>
        <td>${m.stockTurn.toFixed(1)}</td>
        <td>${m.gmroii.toFixed(2)}</td>
        <td>$${m.annualGrossMargin.toFixed(0)}</td>
      </tr>`;
    }).join('');
  }

  // --- Earning Power Decline chart ---
  function renderEarningChart(inp) {
    const container = $('earningChart');
    const d = inp.discount;
    const costPerCopy = inp.price * (1 - d);
    const marginPerCopy = inp.price * d;
    const marginPerDollar = d > 0 && d < 1 ? d / (1 - d) : 0;

    // For a single copy sitting on the shelf for W weeks:
    // If it sells at week W, annualized GMROII = (marginPerCopy / costPerCopy) * (52/W)
    // = marginPerDollar * (52/W)
    const weeks = [1, 2, 3, 4, 6, 8, 10, 13, 16, 20, 26, 39, 52];
    const values = weeks.map(w => marginPerDollar * (52 / w));
    const maxVal = Math.max(...values, 1);

    const chartAreaHeight = 170; // px for bars

    // Build Y axis
    const ySteps = 5;
    let yAxisHtml = '';
    for (let i = ySteps; i >= 0; i--) {
      yAxisHtml += `<span>${((maxVal / ySteps) * i).toFixed(1)}</span>`;
    }

    // Build bars
    let barsHtml = `<div class="chart-y-axis">${yAxisHtml}</div>`;
    weeks.forEach((w, i) => {
      const v = values[i];
      const h = maxVal > 0 ? (v / maxVal) * chartAreaHeight : 0;
      const hue = Math.max(0, 120 - (w / 52) * 120); // green to red
      const color = `hsl(${hue}, 70%, 45%)`;
      barsHtml += `
        <div class="bar-wrapper">
          <div class="bar" style="height:${h}px; background:${color};">
            <div class="bar-value" style="color:${color};">${v.toFixed(1)}</div>
          </div>
          <div class="bar-label">Wk ${w}</div>
        </div>`;
    });

    container.innerHTML = barsHtml;
  }

  // --- Discount Step Advisor ---
  function recalcAdvisor() {
    const dCurr = (parseFloat(advCurrDiscount.value) || 0) / 100;
    const dNext = (parseFloat(advNextDiscount.value) || 0) / 100;
    const qCurr = parseInt(advCurrQty.value) || 0;
    const qNext = parseInt(advNextQty.value) || 0;

    const resultDiv = $('advisorResult');
    const verdictDiv = $('advisorVerdict');
    const explDiv = $('advisorExplanation');

    if (dNext <= dCurr || qNext <= qCurr || dCurr <= 0) {
      resultDiv.className = 'advisor-result neutral';
      verdictDiv.textContent = 'Check inputs';
      explDiv.textContent = 'Next tier discount must be higher than current, and next tier quantity must be larger.';
      return;
    }

    // The 4% rule: each 1% increase in discount is worth ~4% more copies.
    // More precisely: is the extra margin from the higher discount on ALL copies
    // greater than the carrying cost of the extra copies?
    const discountGainPct = ((dNext - dCurr) * 100); // percentage points gained
    const qtyIncreasePct = ((qNext - qCurr) / qCurr) * 100;

    // Shatzkin's rule of thumb: each 1% discount point is worth ordering ~4% more copies.
    // So allowable qty increase = discountGainPct * 4 (as %)
    const allowableIncreasePct = discountGainPct * 4;

    // Total margin at current: qCurr * price * dCurr
    // Total margin at next:    qNext * price * dNext
    // We care about margin per dollar invested ratio change
    const marginPerDollarCurr = dCurr / (1 - dCurr);
    const marginPerDollarNext = dNext / (1 - dNext);
    const marginGainPct = ((marginPerDollarNext - marginPerDollarCurr) / marginPerDollarCurr) * 100;

    const worthIt = qtyIncreasePct <= allowableIncreasePct;

    if (worthIt) {
      resultDiv.className = 'advisor-result worth-it';
      verdictDiv.textContent = 'Worth it';
      explDiv.innerHTML = `The <strong>+${discountGainPct.toFixed(1)}%</strong> discount gain allows up to <strong>~${allowableIncreasePct.toFixed(0)}%</strong> more copies (4% rule). ` +
        `You need <strong>+${qtyIncreasePct.toFixed(1)}%</strong> more copies &mdash; within the allowable range. ` +
        `Margin per dollar improves from <strong>${marginPerDollarCurr.toFixed(3)}</strong> to <strong>${marginPerDollarNext.toFixed(3)}</strong> (+${marginGainPct.toFixed(1)}%).`;
    } else {
      resultDiv.className = 'advisor-result not-worth-it';
      verdictDiv.textContent = 'Not worth it';
      explDiv.innerHTML = `The <strong>+${discountGainPct.toFixed(1)}%</strong> discount gain allows up to <strong>~${allowableIncreasePct.toFixed(0)}%</strong> more copies (4% rule). ` +
        `But you need <strong>+${qtyIncreasePct.toFixed(1)}%</strong> more copies &mdash; exceeds the allowable range. ` +
        `The extra inventory carrying cost outweighs the margin improvement. ` +
        `Margin per dollar only goes from <strong>${marginPerDollarCurr.toFixed(3)}</strong> to <strong>${marginPerDollarNext.toFixed(3)}</strong> (+${marginGainPct.toFixed(1)}%).`;
    }
  }

  // --- Master recalc ---
  function recalc() {
    const inp = getInputs();
    const m = calcMetrics(inp);
    renderMetrics(m);
    renderComparison(inp);
    renderEarningChart(inp);
  }

  // --- Init ---
  recalc();
  recalcAdvisor();
})();
</script>
</body>
</html>
